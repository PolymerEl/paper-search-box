<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="paper-search-box-icons.html">
<dom-module id="paper-search-box">
  <template id="search">
    <iron-icon prefix slot="prefix" icon="paper-search-box:search"></iron-icon>
    <iron-icon slot="suffix" suffix icon="paper-search-box:clear" on-tap="clear"></iron-icon>
  </template>
  <template id="progress">
    <paper-progress value="10" indeterminate="[[loading]]"></paper-progress>
  </template>
  <template id="style">
    <style>
    paper-progress {
      width: 100%;
      margin-top: -8px;
      opacity: 0;
      -webkit-transition: opacity 0.1s;
      /* Safari */
      transition: opacity 0.1s;
      --paper-progress-active-color: var(--paper-search-progress-color, var(--primary-color));
    }

    :host([loading]) paper-progress {
      opacity: 1;
    }

    [slot="suffix"] {
      opacity: 0;
      -webkit-transition: opacity 0.1s;
      /* Safari */
      transition: opacity 0.1s;
    }

    :host([has-value]) [slot="suffix"] {
      opacity: 1;
    }
    </style>
  </template>
  <script>
  (function() {

    let subTemplate;

    customElements.whenDefined('paper-dropdown-menu').then(() => {

      /**
       * ## PaperSearchBox
       *
       * `<paper-search-box>` an extension of paper-dropdown-menu 
       *
       * @memberof PolymerEl
       * @customElement
       * @polymer
       * @demo
       **/
      const PaperDropdownMenu = customElements.get('paper-dropdown-menu');

      class PaperSearchBox extends PaperDropdownMenu {

        static get is() { return 'paper-search-box'; }

        static get properties() {
          return {

            /* 
             * `hasValue` used to hide clear button when this element has a value
             */
            hasValue: {
              type: Boolean,
              reflectToAttribute: true,
              computed: '_hasValue(selectedItemLabel)'
            },

            /* 
             * `loading` true to indicate that smth is loading
             */
            loading: {
              type: Boolean,
              reflectToAttribute: true
            },

            verticalOffset: {
              type: Number,
              value: 54
            },

            /* 
             * `width` notify the width of the component so taht we can align attached menu 
             */
            width: {
              type: String,
              notify: true
            }
          };
        }

        // Note(cg): extend baseclass template by inserting `subTpl` within #chart.
        static get template() {
          if (!subTemplate) {
            subTemplate = PaperDropdownMenu.template.cloneNode(true);

            const tplSearch = Polymer.DomModule.import('paper-search-box', 'template#search').content;
            const tplProgress = Polymer.DomModule.import('paper-search-box', 'template#progress').content;
            const tplStyle = Polymer.DomModule.import('paper-search-box', 'template#style').content;
            const anchor = subTemplate.content.querySelector('paper-input');

            subTemplate.content.querySelector('style').parentNode.appendChild(tplStyle);

            anchor.replaceChild(tplSearch, anchor.querySelector('iron-icon'));
            anchor.parentNode.appendChild(tplProgress);
          }
          return subTemplate;
        }

        /* 
         * remove list data
         */
        clear(e) {
          e.stopPropagation();
          if (this.$.menuButton._dropdownContent) {
            this.$.menuButton._dropdownContent.select(null);
          }
          this._setSelectedItem(null);
        }

        _openedChanged() {
          this.width = this.getBoundingClientRect().width;
          super._openedChanged();
        }

        _hasValue(label) {
          return !!label;
        }
      }

      customElements.define(PaperSearchBox.is, PaperSearchBox);

      if (!window.PolymerEl) {
        window.PolymerEl = {};
      }

      /* 
       * @namespace PolymerEl
       */
      window.PolymerEl.PaperSearchBox = PaperSearchBox;

    });
  })();
  </script>
</dom-module>